
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محرر PDF يدعم العربية</title>
  <style>
    body { font-family: 'Cairo', sans-serif; margin: 20px; text-align: center; direction: rtl; }
    canvas { border: 1px solid #ccc; margin-bottom: 10px; }
    .draggable { position: absolute; cursor: move; border: 1px dashed #ccc; padding: 2px; }
    .controls { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2><b>محرر PDF</b> يدعم العربية</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="file" id="pdfFile" accept=".pdf">
    <button type="submit">رفع PDF</button>
  </form>

  <div class="controls">
    <input type="text" id="textInput" placeholder="نص">
    <input type="color" id="textColor" value="#d50000">
    <select id="fontSize">
      <option value="12">12</option>
      <option value="18" selected>18</option>
      <option value="24">24</option>
    </select>
    <input type="file" id="imageInput" accept="image/*">
    <button onclick="savePDF()">تحميل PDF</button>
  </div>

  <div id="pdfContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script>
    let filename = '';
    let elements = [];

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const fileInput = document.getElementById('pdfFile');
      if (!fileInput.files.length) {
        alert("الرجاء اختيار ملف PDF.");
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.status === 'ok') {
          alert("✅ تم رفع الملف بنجاح!");
          filename = data.filename;
          renderPDF(URL.createObjectURL(fileInput.files[0]));
        } else {
          alert("❌ فشل في رفع الملف.");
        }

      } catch (err) {
        alert("⚠️ خطأ أثناء رفع الملف: " + err.message);
      }
    });

    function renderPDF(url) {
      const container = document.getElementById('pdfContainer');
      container.innerHTML = '';
      pdfjsLib.getDocument(url).promise.then(pdf => {
        for (let i = 1; i <= pdf.numPages; i++) {
          pdf.getPage(i).then(page => {
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.dataset.page = i - 1;
            page.render({ canvasContext: context, viewport: viewport });
            canvas.addEventListener('click', e => placeText(e, canvas));
            container.appendChild(canvas);
          });
        }
      });
    }

    function placeText(e, canvas) {
      const text = document.getElementById('textInput').value;
      const color = document.getElementById('textColor').value;
      const size = document.getElementById('fontSize').value;
      const x = e.offsetX;
      const y = e.offsetY;
      const div = document.createElement('div');
      div.className = 'draggable';
      div.contentEditable = true;
      div.innerText = text;
      div.style.left = x + 'px';
      div.style.top = y + 'px';
      div.style.fontSize = size + 'px';
      div.style.color = color;
      div.style.position = 'absolute';
      canvas.parentElement.appendChild(div);
      elements.push({
        type: 'text',
        text,
        page: canvas.dataset.page,
        x, y,
        size,
        color
      });
    }

    function savePDF() {
      const data = new FormData();
      data.append('data', JSON.stringify({ filename, elements }));
      fetch('/generate', {
        method: 'POST',
        body: data
      }).then(res => res.blob()).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'final.pdf';
        a.click();
      });
    }
  </script>
</body>
</html>
